services:
  caddy:
    image: caddy:2
    container_name: kbx_caddy
    restart: unless-stopped
    depends_on:
      - opencode
    ports:
      - "${OPENCODE_PORT:-4096}:4096"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro

  opencode:
    image: ${OPENCODE_IMAGE:-ghcr.io/bon5co/opencode-webui-workspace:latest}
    container_name: kbx_opencode
    restart: unless-stopped
    # Explicitly bind to 0.0.0.0 inside the container so Caddy can reach it.
    # NOTE: image entrypoint is already `opencode`, so the command should be subcommand args.
    command: ["web", "--port", "4096", "--hostname", "0.0.0.0"]
    environment:
      OPENCODE_SERVER_USERNAME: ${OPENCODE_SERVER_USERNAME:-opencode}
      OPENCODE_SERVER_PASSWORD: ${OPENCODE_SERVER_PASSWORD}
      OPENCODE_PORT: 4096
      OPENCODE_HOSTNAME: 0.0.0.0
    volumes:
      - /srv/agent/opencode-workspace:/home/opencode/workspace
    # Convenience: publish a dev-port range so ad-hoc servers started *inside* OpenCode
    # (i.e. inside this container) can be reached over Tailscale.
    # Pair with UFW allow on tailscale0 (see scripts/configure_firewall.sh).
    ports:
      - "8000-8999:8000-8999"

  login_portal:
    image: ${LOGIN_PORTAL_IMAGE:-lscr.io/linuxserver/firefox:latest}
    container_name: kbx_login_portal
    restart: unless-stopped
    shm_size: "1gb"
    environment:
      PUID: "1000"
      PGID: "1000"
      TZ: ${TZ:-UTC}
    ports:
      - "${LOGIN_PORTAL_PORT:-3001}:3000"
    volumes:
      - /srv/agent/browser-profile:/config
      - /srv/agent/dropbox:/dropbox
