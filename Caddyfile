:4096 {
  # Reverse proxy OpenCode through Caddy so we can relax CSP enough
  # for the in-browser terminal's WASM worker to run.
  reverse_proxy opencode:4096 {
    # If OpenCode sets its own CSP header, browsers enforce the intersection
    # of multiple CSP headers. Strip upstream CSP first, then set ours below.
    header_down -Content-Security-Policy
  }

  # Replace upstream CSP (which blocks WASM instantiation in some browsers).
  # This policy is intentionally pragmatic for a Tailscale-only service.
  header Content-Security-Policy "default-src 'self' data: blob:; script-src 'self' 'unsafe-eval' 'wasm-unsafe-eval' blob:; worker-src 'self' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' ws: wss:; object-src 'none'; base-uri 'self'"
}
